<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.mapper.CashTransferMapper">

    <resultMap type="org.example.pojo.dtos.CashTransferAllDTO" id="selectCashTransferAllMap">
        <result property="seqNo"     column="SeqNo"     />
        <result property="transferDate"     column="TransferDate"     />
        <result property="status"     column="Status"     />
        <result property="clntCodeFrom"     column="ClntCodeFrom"     />
        <result property="clntCodeTo"     column="ClntCodeTo"     />
        <result property="acctTypeFrom"     column="AcctTypeFrom"     />
        <result property="acctTypeTo"     column="AcctTypeTo"     />
        <result property="marketFrom"     column="MarketFrom"     />
        <result property="marketTo"     column="MarketTo"     />
        <result property="cCYFrom"     column="CCYFrom"     />
        <result property="cCYTo"     column="CCYTo"     />
        <result property="bankFrom"     column="BankFrom"     />
        <result property="bankTo"     column="BankTo"     />
        <result property="amountFrom"     column="AmountFrom"     />
        <result property="amountTo"     column="AmountTo"     />
        <result property="fXRate"     column="FXRate"     />
        <result property="remarksFrom"     column="RemarksFrom"     />
        <result property="remarksTo"     column="RemarksTo"     />
        <result property="userIDSave"     column="UserIDSave"     />
        <result property="userIDCancel"     column="UserIDCancel"     />
        <result property="buyInXRate"     column="BuyInXRate"     />
        <result property="sellOutXRate"     column="SellOutXRate"     />
        <result property="cancelDateFrom"     column="CancelDateFrom"     />
        <result property="cancelDateTo"     column="CancelDateTo"     />
        <result property="approverFrom"     column="ApproverFrom"     />
        <result property="approverTo"     column="ApproverTo"     />
        <result property="approvalTimeFrom"     column="ApprovalTimeFrom"     />
        <result property="approvalTimeTo"     column="ApprovalTimeTo"     />
    </resultMap>

    <select id="selectCashTransferAll" resultMap="selectCashTransferAllMap">
        WITH CashTransferDetailCombined AS (
        SELECT
        SeqNo = COALESCE(CT1.SeqNo, CT2.SeqNo),
        MarketFrom = CT1.Market,
        CCYFrom = CT1.CCY,
        VoucherNoFrom = CT1.VoucherNo,
        ClntCodeFrom = CT1.ClntCode,
        AcctTypeFrom = CT1.AcctType,
        BankFrom = CT1.Bank,
        RemarksFrom = CT1.Remarks,
        StatusFrom = CT1.Status,
        AmountFrom = CV1.Amount,
        CancelDateFrom = CV1.CancelDate,
        ApproverFrom = CV1.Approver,
        ApprovalTimeFrom = CV1.ApprovalTime,

        MarketTo = CT2.Market,
        CCYTo = CT2.CCY,
        VoucherNoTo = CT2.VoucherNo,
        ClntCodeTo = CT2.ClntCode,
        AcctTypeTo = CT2.AcctType,
        BankTo = CT2.Bank,
        RemarksTo = CT2.Remarks,
        StatusTo = CT2.Status,
        AmountTo = CV2.Amount,
        CancelDateTo = CV2.CancelDate,
        ApproverTo = CV2.Approver,
        ApprovalTimeTo = CV2.ApprovalTime
        FROM
        CashTransferDetail CT1
        LEFT JOIN CashVoucher CV1
        ON CT1.Market = CV1.Market
        AND CT1.VoucherNo = CV1.VoucherNo
        LEFT JOIN CashTransferDetail CT2
        ON CT2.SeqNo = CT1.SeqNo
        AND CT2.ClntCode = CT1.ClntCode
        AND CT2.AcctType = CT1.AcctType
        AND CT2.FromTo = '2'
        LEFT JOIN CashVoucher CV2
        ON CT2.Market = CV2.Market
        AND CT2.VoucherNo = CV2.VoucherNo
        WHERE
        CT1.FromTo = '1'
        )
        SELECT
        --count(*) as totalCount
        A.SeqNo,
        A.TransferDate,
        A.Status,
        B.ClntCodeFrom,
        B.ClntCodeTo,
        B.AcctTypeFrom,
        B.AcctTypeTo,
        B.MarketFrom,
        B.MarketTo,
        B.CCYFrom,
        B.CCYTo,
        B.BankFrom,
        B.BankTo,
        B.AmountFrom,
        B.AmountTo,
        A.FXRate,
        B.RemarksFrom,
        B.RemarksTo,
        A.UserIDSave,
        A.UserIDCancel,
        A.BuyInXRate,
        A.SellOutXRate,
        B.CancelDateFrom,
        B.CancelDateTo,
        B.ApproverFrom,
        B.ApproverTo,
        B.ApprovalTimeFrom,
        B.ApprovalTimeTo
        FROM
        CashTransfer A
        JOIN CashTransferDetailCombined B ON A.SeqNo = B.SeqNo
        WHERE
        B.CCYFrom != B.CCYTo
        ORDER BY
        A.SeqNo,
        B.ClntCodeFrom
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY;
    </select>

</mapper>
